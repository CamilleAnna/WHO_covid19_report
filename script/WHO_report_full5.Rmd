---
title: "COVID-19 situation report for WH0 Africa Region"
author: "Produced by the TIBA COVID-19 Epidemic Response Unit"
header-includes:
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
output:
  pdf_document:
subtitle: 08/04/2020
extra_dependencies: float
---


```{r setup, include=FALSE}


# SET UP CHUNK OPTIONS ---
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(message=FALSE)


today<- Sys.Date() - 2
library(plyr)

load(paste0('/Users/s1687811/Documents/GitHub/WHO_covid19_report/output/WHO_report_analysis_', as.character(today), '.RData'))
source('/Users/s1687811/Documents/GitHub/WHO_covid19_report/script/sourced_functions_doublingTime_reports.R')

# FIGURES PARAMETERS ---
palette<- brewer.pal(10, 'Paired') # 10 colorblind-friendly palette
palette.top10<- c(rep('black', ncol(d) - length(palette)), palette) # 10 colors, the rest black


# FIGURES PARAMETERS

# conventions:
# each element is followed by .f1, ..., .fn for figure1, ..., figuren
# y.axti / x.axti = y/x axis ticks interval
# yseq / xseq = sequence of y/x axes ticks to plot
# y.cex / x.cex = font size of y / x axis
# y.font / x.font = font type of y / x axis (1 = normal, 2 = bold)

# ylab.cex = size of y-axis label
# ylab.f =   font of y-axis label
# ylab.line =  space between figure and y-axis label


date.format = "%d/%m"

# PARAMETERS FIGURE 1 ----
start.date.f1 = as.Date("2020-03-08") # forced starting date for x-axis in fig1
x.axti.f1 = 5
y.axti.f1 = 100

secondWorst<- rev(sort(tail(d, 1)[,-1]))[[2]]
secondWorstPadded<- round_any(secondWorst, 100)
yseq.f1 = seq(0, secondWorstPadded, y.axti.f1) 
#yseq.f1 = seq(0, max(d.long$cumNumCases) - (max(d.long$cumNumCases) %% y.axti.f1), y.axti.f1)
xseq.f1 = seq.Date(from = start.date.f1, to = max(d$date), by = x.axti.f1)

x.font.f1 = 2
y.font.f1 = 2

x.cex.f1 = 1
y.cex.f1 = 1

ylab.cex.f1 = 1.2
ylab.f.f1 = 2
ylab.line.f1 = 2.5 

xlab.cex.f1 = 1.2
xlab.f.f1 = 2
xlab.line.f1 = 2.5

# PARAMETERS FIGURE 2 ----
start.date.f2 = as.Date("2020-03-08") # forced starting date for x-axis in fig2
x.axti.f2 = 7
y.axti.f2 = 1


yseq.f2 = seq(
min(d.10k.log.long$cumcases_10k_log, na.rm = TRUE) - min(d.10k.log.long$cumcases_10k_log, na.rm = TRUE) %% y.axti.f2,
max(d.10k.log.long$cumcases_10k_log, na.rm = TRUE) - max(d.10k.log.long$cumcases_10k_log, na.rm = TRUE) %% y.axti.f2,
y.axti.f2)
xseq.f2 = seq.Date(from = start.date.f2, to = max(d.10k.log$date), by = x.axti.f2)


x.font.f2 = 2
y.font.f2 = 2

x.cex.f2 = 1
y.cex.f2 = 1

ylab.cex.f2 = 1.2
ylab.f.f2 = 2
ylab.line.f2 = 2.5 

xlab.cex.f2 = 1.2
xlab.f.f2 = 2
xlab.line.f2 = 2.5

# PARAMETERS FIGURE 4 ----
start.date.f4 = as.Date("2020-03-08") # forced starting date for x-axis in fig1
x.axti.f4 = 2
y.axti.f4 = 1

yseq.f4 = seq(0, max(d.deaths.long$cumNumDeaths) - (max(d.deaths.long$cumNumDeaths) %% y.axti.f4), y.axti.f4)
xseq.f4 = seq.Date(from = start.date.f4, to = max(d.deaths$date), by = x.axti.f4)

x.font.f4 = 2
y.font.f4 = 2

x.cex.f4 = 1
y.cex.f4 = 1

ylab.cex.f4 = 1.2
ylab.f.f4 = 2
ylab.line.f4 = 2.5 

xlab.cex.f4 = 1.2
xlab.f.f4 = 2
xlab.line.f4 = 2.5


# PARAMETERS FIGURE BY COUNTRY  (bc)----
x.font.fbc = 2
y.font.fbc = 2

x.cex.fbc = 1.2
y.cex.fbc = 1.2

ylab.cex.fbc = 1.2
ylab.f.fbc = 2
ylab.line.fbc = 1 


xTOPlab.cex.fbc = 1.2
xTOPlab.f.fbc = 2
xTOPlab.line.fbc = 0


xBOTTOMlab.cex.fbc = 1.2
xBOTTOMlab.f.fbc = 2
xBOTTOMlab.line.fbc = 1


start.date.fbc = as.Date("2020-03-08") # forced starting date for x-axis in fig1
x.axti.fbc = 5
y.axti.fbc.rawCases = 100
y.axti.fbc.rawDeaths = 5
y.axti.fbc.logCases = 1
y.axti.fbc.logDeaths = 1

xseq.fbc = seq.Date(from = min(d$date), to = max(d$date), by = x.axti.fbc)

# y-scale for raw cases
thirdWorst<- rev(sort(tail(d, 1)[,-1]))[[3]]
thirdWorstPadded<- round_any(thirdWorst, 100)
yseq.raw.cases = seq(0, thirdWorstPadded, y.axti.fbc.rawCases) 

# y-scale for raw deaths
secondworstDeaths<- rev(sort(tail(d.deaths,1)[,-1]))[[2]]
secondworstDeathsPadded<- secondworstDeaths+1 #round_any(worstDeaths, 10, f = ceiling)
yseq.raw.deaths = seq(0, secondworstDeathsPadded, y.axti.fbc.rawDeaths)

# y-scale for log 10k cases
yseq.log.cases<- seq(round_any(range(d.10k.log[,2:ncol(d.10k.log)], na.rm = TRUE)[1], 1, f = floor),
                   round_any(range(d.10k.log[,2:ncol(d.10k.log)], na.rm = TRUE)[2], 1, f = ceiling),
                   y.axti.fbc.logCases)


# y-scale for log 10k deaths
yseq.log.deaths<- seq(round_any(range(d.deaths.10k.log[,2:ncol(d.deaths.10k.log)], na.rm = TRUE)[1], 1, f = floor),
                     round_any(range(d.deaths.10k.log[,2:ncol(d.deaths.10k.log)], na.rm = TRUE)[2], 1, f = ceiling),
                     y.axti.fbc.logDeaths)



```
&nbsp;

\newpage

\tableofcontents

\newpage


# Section 1: Overview

We compare the size and rate of increase of the COVID-19 epidemic across the countries included in WHO Africa Region.

```{r mapWHO, fig.align = 'center', out.width= "75%"}
knitr::include_graphics("/Users/s1687811/Documents/GitHub/WHO_covid19_report/input_files/WHO_Africa.png")
```


\newpage

 
```{r mapSummaries, fig.align = 'center', out.width= "100%"}
knitr::include_graphics(paste0("/Users/s1687811/Documents/GitHub/WHO_covid19_report/output/6Maps_WHO_Africa_", today, "_.png"))
```

&nbsp;

The maps above summarise the in-country situations:  
 
* Top-left: cumulated reported cases.  
* Top-right: cumulated reported cases per 10,000 population on a log10 scale.  
* Middle-left: cumulated reported deaths.  
* Middle-right: cumulated reported deaths per 10,000 population on a log10 scale.  
* Bottom-left: Overview of doubling time of cumulative incidence. Doubling times are calculated over a 7 day period up to `r format(today, "%d/%m/%Y")`.  
* Bottom-right: Overview of doubling time of cumulative deaths per 10,000 population. Doubling times are calculated over a 7 day period up to `r format(today, "%d/%m/%Y")`.  

\newpage

```{r heatmap, echo=FALSE, fig.align = 'left', fig.height = 11, fig.width = 11, fig.fullwidth = TRUE}
    
ggplot(upper, aes(x = `compared to`, y = `focal country`, fill= `Time difference (days)`)) + 
  geom_tile()+
  xlab('')+ylab('')+
  scale_fill_gradient(low="white", high="firebrick") +
  geom_text(aes(label = epidemic.diff.text, x = `compared to`, y = `focal country`), size = 2, fontface = 2)+
  #scale_x_discrete(position = "top")+
  theme_bw()+
  theme(legend.position="top",
    panel.border= element_rect(color = 'black', size = 0.5),
    axis.text.y = element_text(face="bold", colour="black", size=10),
    axis.text.x = element_text(colour="black", face="bold", size=10, angle = 45, hjust = 0.95, vjust = 1),
    axis.title.y = element_text(face="bold", colour="black", size=15),
    axis.title.x = element_text(face="bold", colour="black", size=15),
    axis.line.y = element_line(color="black", size = 0.5),
    axis.line.x = element_line(color="black", size = 0.5),
    plot.title = element_text(lineheight=.8, face="bold", hjust = 0.5),
    panel.grid.major = element_line(color = 'grey', linetype = 'dotted'))

```
&nbsp;

**Figure 1. Pairwise epidemic progression comparison across WHO Africa region**. The reported numbers are the numbers of days ahead the countries in horizontal entries, arranged from most ahead to least ahead, are relative to the countries in vertical entries. The full matrix is symetric. Only the upper half is represented. Grey shades appear in each case of (i) a country compared to itself or (ii) the two countries compared have not reached similar epidemic progression yet.


\newpage


# Appendix
## Data
### Sources and access
- Case counts for countries in WHO African region from WHO Coronavirus disease (COVID-2019) situation reports https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports (accessed 2400 `r format(today, "%d/%m/%Y")`).  
- Death counts for countries in WHO African region from WHO Coronavirus disease (COVID-2019) situation reports https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports (accessed 2400 `r format(today, "%d/%m/%Y")`).  
- Population counts from the World Bank (2018) https://data.worldbank.org/indicator/SP.POP.TOTL?locations=ZG (accessed 0900  30/03/2020). 



###Doubling time calculations

Calculated over prior 7 days using method described by *E. Vynnycky & R. White (2010) An Introduction to Infectious Disease Modelling*, page 74.  
  
Confidence intervals calculated using bootstrapping of a simulated dataset with Poisson error structure, using method published here: https://doi.org/10.1101/2020.02.05.20020750.  

### Caveats
- Case count data are affected by any changes in testing strategy or testing effort over time and/or any variation in testing strategy or testing effort between regions.  
- Case count data are likely a substantial under-representation of the true number of COVID-19 infections.  
- Death data are considered more reliable but may lag behind case data by as much as 3 weeks.  

\newpage


## Extended data tables

\newpage

### Cumulative incidence
&nbsp;
```{r TabIncidenceRaw, results = 'asis', echo = FALSE}
# Table produced in the analysis script, as it requires the 95%CI, extracted from the simulations

kable(dat.cumsumraw.df)
```

\newpage

### Cumulative incidence per 10,000 population

&nbsp;

```{r TabIncidence10k, results = 'asis', echo = FALSE}
# Table produced in the analysis script, as it requires the 95%CI, extracted from the simulations
kable(dat.cumsum10k.df)
```

\newpage

### Cumulative deaths
&nbsp;

```{r TabDeathsRaw, results = 'asis', echo = FALSE}
# This does not report CI so directly get it from the data tables

tab.total.deaths<- d.deaths.long %>%
  group_by(country) %>%
  slice(n()) %>%
  ungroup() %>%
  select(-date) %>%
  arrange(-cumNumDeaths) %>%
  rename(Country = country,
         `Cumulative deaths` = cumNumDeaths)

kable(tab.total.deaths)
```

\newpage

### Cumulative deaths per 10,000 populations
&nbsp;

```{r TabDeaths10k, results = 'asis', echo = FALSE}
# This does not report CI so directly get it from the data tables

tab.total.deaths.10k<- d.deaths.10k.log.long %>%
  mutate(cumdeaths_10k = 10^(cumdeaths_10k_log)) %>%
  group_by(country) %>%
  slice(n()) %>%
  ungroup() %>%
  select(-date, -cumdeaths_10k_log) %>%
  arrange(-cumdeaths_10k) %>%
  rename(Country = country,
         `Cumulative deaths per 10k pop.` = cumdeaths_10k)

kable(tab.total.deaths.10k)
```

\newpage

### Doubling time (incidence)
&nbsp;


```{r DtTabIncidence, results = 'asis', echo = FALSE}
kable(Td.report.clean2)
```

\newpage

### Doubling time (deaths)
```{r DtTabDeaths, results = 'asis', echo = FALSE}
kable(Td.report.deaths.clean2)
```








